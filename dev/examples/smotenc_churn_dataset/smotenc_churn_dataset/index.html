<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>SMOTENC on Customer Churn Data · Imbalance.jl</title><meta name="title" content="SMOTENC on Customer Churn Data · Imbalance.jl"/><meta property="og:title" content="SMOTENC on Customer Churn Data · Imbalance.jl"/><meta property="twitter:title" content="SMOTENC on Customer Churn Data · Imbalance.jl"/><meta name="description" content="Documentation for Imbalance.jl."/><meta property="og:description" content="Documentation for Imbalance.jl."/><meta property="twitter:description" content="Documentation for Imbalance.jl."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="https://fonts.googleapis.com/css?family=Montserratwght@100;200;300;400;500;600;700;800;900|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.gif" alt="Imbalance.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Imbalance.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Introduction</a></li><li><span class="tocitem">Algorithms</span><ul><li><a class="tocitem" href="../../../algorithms/oversampling_algorithms/">Oversampling</a></li><li><a class="tocitem" href="../../../algorithms/undersampling_algorithms/">Undersampling</a></li><li><a class="tocitem" href="../../../algorithms/mlj_balancing/">Combination</a></li><li><a class="tocitem" href="../../../algorithms/extra_algorithms/">Extras</a></li></ul></li><li><span class="tocitem">Tutorial</span><ul><li><a class="tocitem" href="../../walkthrough/">Introduction</a></li><li><a class="tocitem" href="../../">More Examples</a></li></ul></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../../about/">About</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>SMOTENC on Customer Churn Data</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>SMOTENC on Customer Churn Data</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaAI/Imbalance.jl/" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="SMOTENC-on-Customer-Churn-Data"><a class="docs-heading-anchor" href="#SMOTENC-on-Customer-Churn-Data">SMOTENC on Customer Churn Data</a><a id="SMOTENC-on-Customer-Churn-Data-1"></a><a class="docs-heading-anchor-permalink" href="#SMOTENC-on-Customer-Churn-Data" title="Permalink"></a></h1><pre><code class="language-julia hljs">using Imbalance
using MLJBalancing
using CSV
using DataFrames
using ScientificTypes
using CategoricalArrays
using MLJ
using Plots
using Random</code></pre><h2 id="Loading-Data"><a class="docs-heading-anchor" href="#Loading-Data">Loading Data</a><a id="Loading-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-Data" title="Permalink"></a></h2><p>In this example, we will consider the <a href="https://www.kaggle.com/datasets/mathchi/churn-for-bank-customers">Churn for Bank Customers</a> found on Kaggle where the objective is to predict whether a customer is likely to leave a bank given financial and demographic features. </p><p>We already considered this dataset using SMOTE, in this example we see if the results are any better using SMOTE-NC.</p><pre><code class="language-julia hljs">df = CSV.read(&quot;../datasets/churn.csv&quot;, DataFrame)
first(df, 5) |&gt; pretty</code></pre><pre><code class="nohighlight hljs">┌───────────┬────────────┬──────────┬─────────────┬───────────┬─────────┬───────┬────────┬────────────┬───────────────┬───────────┬────────────────┬─────────────────┬────────┐
│ RowNumber │ CustomerId │ Surname  │ CreditScore │ Geography │ Gender  │ Age   │ Tenure │ Balance    │ NumOfProducts │ HasCrCard │ IsActiveMember │ EstimatedSalary │ Exited │
│ Int64     │ Int64      │ String31 │ Int64       │ String7   │ String7 │ Int64 │ Int64  │ Float64    │ Int64         │ Int64     │ Int64          │ Float64         │ Int64  │
│ Count     │ Count      │ Textual  │ Count       │ Textual   │ Textual │ Count │ Count  │ Continuous │ Count         │ Count     │ Count          │ Continuous      │ Count  │
├───────────┼────────────┼──────────┼─────────────┼───────────┼─────────┼───────┼────────┼────────────┼───────────────┼───────────┼────────────────┼─────────────────┼────────┤
│ 1         │ 15634602   │ Hargrave │ 619         │ France    │ Female  │ 42    │ 2      │ 0.0        │ 1             │ 1         │ 1              │ 1.01349e5       │ 1      │
│ 2         │ 15647311   │ Hill     │ 608         │ Spain     │ Female  │ 41    │ 1      │ 83807.9    │ 1             │ 0         │ 1              │ 1.12543e5       │ 0      │
│ 3         │ 15619304   │ Onio     │ 502         │ France    │ Female  │ 42    │ 8      │ 1.59661e5  │ 3             │ 1         │ 0              │ 1.13932e5       │ 1      │
│ 4         │ 15701354   │ Boni     │ 699         │ France    │ Female  │ 39    │ 1      │ 0.0        │ 2             │ 0         │ 0              │ 93826.6         │ 0      │
│ 5         │ 15737888   │ Mitchell │ 850         │ Spain     │ Female  │ 43    │ 2      │ 1.25511e5  │ 1             │ 1         │ 1              │ 79084.1         │ 0      │
└───────────┴────────────┴──────────┴─────────────┴───────────┴─────────┴───────┴────────┴────────────┴───────────────┴───────────┴────────────────┴─────────────────┴────────┘</code></pre><p>Let&#39;s get rid of useless columns such as <code>RowNumber</code> and <code>CustomerId</code></p><pre><code class="language-julia hljs">df = df[:, Not([:Surname, :RowNumber, :CustomerId])]

first(df, 5) |&gt; pretty</code></pre><pre><code class="nohighlight hljs">┌─────────────┬───────────┬─────────┬───────┬────────┬────────────┬───────────────┬───────────┬────────────────┬─────────────────┬────────┐
│ CreditScore │ Geography │ Gender  │ Age   │ Tenure │ Balance    │ NumOfProducts │ HasCrCard │ IsActiveMember │ EstimatedSalary │ Exited │
│ Int64       │ String7   │ String7 │ Int64 │ Int64  │ Float64    │ Int64         │ Int64     │ Int64          │ Float64         │ Int64  │
│ Count       │ Textual   │ Textual │ Count │ Count  │ Continuous │ Count         │ Count     │ Count          │ Continuous      │ Count  │
├─────────────┼───────────┼─────────┼───────┼────────┼────────────┼───────────────┼───────────┼────────────────┼─────────────────┼────────┤
│ 619         │ France    │ Female  │ 42    │ 2      │ 0.0        │ 1             │ 1         │ 1              │ 1.01349e5       │ 1      │
│ 608         │ Spain     │ Female  │ 41    │ 1      │ 83807.9    │ 1             │ 0         │ 1              │ 1.12543e5       │ 0      │
│ 502         │ France    │ Female  │ 42    │ 8      │ 1.59661e5  │ 3             │ 1         │ 0              │ 1.13932e5       │ 1      │
│ 699         │ France    │ Female  │ 39    │ 1      │ 0.0        │ 2             │ 0         │ 0              │ 93826.6         │ 0      │
│ 850         │ Spain     │ Female  │ 43    │ 2      │ 1.25511e5  │ 1             │ 1         │ 1              │ 79084.1         │ 0      │
└─────────────┴───────────┴─────────┴───────┴────────┴────────────┴───────────────┴───────────┴────────────────┴─────────────────┴────────┘</code></pre><h2 id="Coercing-Data"><a class="docs-heading-anchor" href="#Coercing-Data">Coercing Data</a><a id="Coercing-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Coercing-Data" title="Permalink"></a></h2><p>Let&#39;s coerce the nominal data to <code>Multiclass</code>, the ordinal data to <code>OrderedFactor</code> and the continuous data to <code>Continuous</code>.</p><pre><code class="language-julia hljs">df = coerce(df, 
              :Geography =&gt; Multiclass, 
              :Gender=&gt; Multiclass,
              :CreditScore =&gt; OrderedFactor,
              :Age =&gt; OrderedFactor,
              :Tenure =&gt; OrderedFactor,
              :Balance =&gt; Continuous,
              :NumOfProducts =&gt; OrderedFactor,
              :HasCrCard =&gt; Multiclass,
              :IsActiveMember =&gt; Multiclass,
              :EstimatedSalary =&gt; Continuous,
              :Exited =&gt; Multiclass
              )

ScientificTypes.schema(df)</code></pre><pre><code class="nohighlight hljs">┌─────────────────┬────────────────────┬───────────────────────────────────┐
│ names           │ scitypes           │ types                             │
├─────────────────┼────────────────────┼───────────────────────────────────┤
│ CreditScore     │ OrderedFactor{460} │ CategoricalValue{Int64, UInt32}   │
│ Geography       │ Multiclass{3}      │ CategoricalValue{String7, UInt32} │
│ Gender          │ Multiclass{2}      │ CategoricalValue{String7, UInt32} │
│ Age             │ OrderedFactor{70}  │ CategoricalValue{Int64, UInt32}   │
│ Tenure          │ OrderedFactor{11}  │ CategoricalValue{Int64, UInt32}   │
│ Balance         │ Continuous         │ Float64                           │
│ NumOfProducts   │ OrderedFactor{4}   │ CategoricalValue{Int64, UInt32}   │
│ HasCrCard       │ Multiclass{2}      │ CategoricalValue{Int64, UInt32}   │
│ IsActiveMember  │ Multiclass{2}      │ CategoricalValue{Int64, UInt32}   │
│ EstimatedSalary │ Continuous         │ Float64                           │
│ Exited          │ Multiclass{2}      │ CategoricalValue{Int64, UInt32}   │
└─────────────────┴────────────────────┴───────────────────────────────────┘</code></pre><h2 id="Unpacking-and-Splitting-Data"><a class="docs-heading-anchor" href="#Unpacking-and-Splitting-Data">Unpacking and Splitting Data</a><a id="Unpacking-and-Splitting-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Unpacking-and-Splitting-Data" title="Permalink"></a></h2><pre><code class="language-julia hljs">y, X = unpack(df, ==(:Exited); rng=123);
first(X, 5) |&gt; pretty</code></pre><pre><code class="nohighlight hljs">┌─────────────────────────────────┬───────────────────────────────────┬───────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┬────────────┬─────────────────────────────────┬─────────────────────────────────┬─────────────────────────────────┬─────────────────┐
│ CreditScore                     │ Geography                         │ Gender                            │ Age                             │ Tenure                          │ Balance    │ NumOfProducts                   │ HasCrCard                       │ IsActiveMember                  │ EstimatedSalary │
│ CategoricalValue{Int64, UInt32} │ CategoricalValue{String7, UInt32} │ CategoricalValue{String7, UInt32} │ CategoricalValue{Int64, UInt32} │ CategoricalValue{Int64, UInt32} │ Float64    │ CategoricalValue{Int64, UInt32} │ CategoricalValue{Int64, UInt32} │ CategoricalValue{Int64, UInt32} │ Float64         │
│ OrderedFactor{460}              │ Multiclass{3}                     │ Multiclass{2}                     │ OrderedFactor{70}               │ OrderedFactor{11}               │ Continuous │ OrderedFactor{4}                │ Multiclass{2}                   │ Multiclass{2}                   │ Continuous      │
├─────────────────────────────────┼───────────────────────────────────┼───────────────────────────────────┼─────────────────────────────────┼─────────────────────────────────┼────────────┼─────────────────────────────────┼─────────────────────────────────┼─────────────────────────────────┼─────────────────┤
│ 669                             │ France                            │ Female                            │ 31                              │ 6                               │ 1.13001e5  │ 1                               │ 1                               │ 0                               │ 40467.8         │
│ 822                             │ France                            │ Male                              │ 37                              │ 3                               │ 105563.0   │ 1                               │ 1                               │ 0                               │ 1.82625e5       │
│ 423                             │ France                            │ Female                            │ 36                              │ 5                               │ 97665.6    │ 1                               │ 1                               │ 0                               │ 1.18373e5       │
│ 623                             │ France                            │ Male                              │ 21                              │ 10                              │ 0.0        │ 2                               │ 0                               │ 1                               │ 1.35851e5       │
│ 691                             │ Germany                           │ Female                            │ 37                              │ 7                               │ 1.23068e5  │ 1                               │ 1                               │ 1                               │ 98162.4         │
└─────────────────────────────────┴───────────────────────────────────┴───────────────────────────────────┴─────────────────────────────────┴─────────────────────────────────┴────────────┴─────────────────────────────────┴─────────────────────────────────┴─────────────────────────────────┴─────────────────┘</code></pre><pre><code class="language-julia hljs">train_inds, test_inds = partition(eachindex(y), 0.8, shuffle=true, 
                                  rng=Random.Xoshiro(42))
X_train, X_test = X[train_inds, :], X[test_inds, :]
y_train, y_test = y[train_inds], y[test_inds]</code></pre><pre><code class="nohighlight hljs">(CategoricalValue{Int64, UInt32}[0, 1, 1, 0, 0, 0, 0, 0, 0, 0  …  0, 0, 0, 1, 0, 0, 0, 0, 1, 0], CategoricalValue{Int64, UInt32}[0, 0, 0, 0, 0, 1, 1, 0, 0, 0  …  0, 0, 0, 0, 0, 0, 0, 0, 0, 0])</code></pre><h2 id="Oversampling"><a class="docs-heading-anchor" href="#Oversampling">Oversampling</a><a id="Oversampling-1"></a><a class="docs-heading-anchor-permalink" href="#Oversampling" title="Permalink"></a></h2><p>Before deciding to oversample, let&#39;s see how adverse is the imbalance problem, if it exists. Ideally, you may as well check if the classification model is robust to this problem.</p><pre><code class="language-julia hljs">checkbalance(y)         # comes from Imbalance</code></pre><pre><code class="nohighlight hljs">1: ▇▇▇▇▇▇▇▇▇▇▇▇▇ 2037 (25.6%) 
0: ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ 7963 (100.0%)</code></pre><p>Looks like we have a class imbalance problem. Let&#39;s oversample with SMOTE-NC and set the desired ratios so that the positive minority class is 90% of the majority class</p><pre><code class="language-julia hljs">Xover, yover = smotenc(X_train, y_train; k=3, ratios=Dict(1=&gt;0.9), rng=42)</code></pre><pre><code class="nohighlight hljs">(12109×10 DataFrame
   Row │ CreditScore  Geography  Gender  Age   Tenure  Balance         NumOfPr ⋯
       │ Cat…         Cat…       Cat…    Cat…  Cat…    Float64         Cat…    ⋯
───────┼────────────────────────────────────────────────────────────────────────
     1 │ 551          France     Female  38    10           0.0        2       ⋯
     2 │ 676          France     Female  37    5        89634.7        1
     3 │ 543          France     Male    42    4        89838.7        3
     4 │ 663          France     Male    34    10           0.0        1
     5 │ 621          Germany    Female  34    2        91258.5        2       ⋯
     6 │ 723          France     Male    28    4            0.0        2
     7 │ 735          France     Female  21    1            1.78718e5  2
     8 │ 501          France     Male    35    6        99760.8        1
   ⋮   │      ⋮           ⋮        ⋮      ⋮      ⋮           ⋮               ⋮ ⋱
 12103 │ 551          France     Female  40    2            1.68002e5  1       ⋯
 12104 │ 716          France     Female  46    2            1.09379e5  2
 12105 │ 850          Spain      Female  45    10           1.66777e5  1
 12106 │ 785          France     Female  39    9            1.33118e5  1
 12107 │ 565          Germany    Female  39    5            1.44874e5  1       ⋯
 12108 │ 510          Germany    Male    43    0            1.38862e5  1
 12109 │ 760          France     Female  41    2       113419.0        1
                                                4 columns and 12094 rows omitted, CategoricalValue{Int64, UInt32}[0, 1, 1, 0, 0, 0, 0, 0, 0, 0  …  1, 1, 1, 1, 1, 1, 1, 1, 1, 1])</code></pre><pre><code class="language-julia hljs">checkbalance(yover)</code></pre><pre><code class="nohighlight hljs">1: ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ 5736 (90.0%) 
0: ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ 6373 (100.0%)</code></pre><h2 id="Training-the-Model"><a class="docs-heading-anchor" href="#Training-the-Model">Training the Model</a><a id="Training-the-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Training-the-Model" title="Permalink"></a></h2><p>Let&#39;s find possible models</p><pre><code class="language-julia hljs">ms = models(matching(Xover, yover))</code></pre><pre><code class="nohighlight hljs">5-element Vector{NamedTuple{(:name, :package_name, :is_supervised, :abstract_type, :deep_properties, :docstring, :fit_data_scitype, :human_name, :hyperparameter_ranges, :hyperparameter_types, :hyperparameters, :implemented_methods, :inverse_transform_scitype, :is_pure_julia, :is_wrapper, :iteration_parameter, :load_path, :package_license, :package_url, :package_uuid, :predict_scitype, :prediction_type, :reporting_operations, :reports_feature_importances, :supports_class_weights, :supports_online, :supports_training_losses, :supports_weights, :transform_scitype, :input_scitype, :target_scitype, :output_scitype)}}:
 (name = CatBoostClassifier, package_name = CatBoost, ... )
 (name = ConstantClassifier, package_name = MLJModels, ... )
 (name = DecisionTreeClassifier, package_name = BetaML, ... )
 (name = DeterministicConstantClassifier, package_name = MLJModels, ... )
 (name = RandomForestClassifier, package_name = BetaML, ... )</code></pre><p>Let&#39;s go for a logistic classifier form MLJLinearModels</p><pre><code class="language-julia hljs">import Pkg; Pkg.add(&quot;BetaML&quot;)</code></pre><p>Let&#39;s go for a decision tree from BetaML. We can&#39;t go for logistic regression as we did in the SMOTE tutorial because it does not support categotical features.</p><h3 id="Before-Oversampling"><a class="docs-heading-anchor" href="#Before-Oversampling">Before Oversampling</a><a id="Before-Oversampling-1"></a><a class="docs-heading-anchor-permalink" href="#Before-Oversampling" title="Permalink"></a></h3><pre><code class="language-julia hljs"># 1. Load the model
DecisionTreeClassifier = @load DecisionTreeClassifier pkg=BetaML

# 2. Instantiate it
model = DecisionTreeClassifier( max_depth=4, rng=Random.Xoshiro(42))

# 3. Wrap it with the data in a machine
mach = machine(model, X_train, y_train)

# 4. fit the machine learning model
fit!(mach, verbosity=0)</code></pre><pre><code class="nohighlight hljs">import BetaML ✔


┌ Info: For silent loading, specify `verbosity=0`. 
└ @ Main /Users/essam/.julia/packages/MLJModels/EkXIe/src/loading.jl:159



trained Machine; caches model-specific representations of data
  model: DecisionTreeClassifier(max_depth = 4, …)
  args: 
    1:	Source @378 ⏎ Table{Union{AbstractVector{Continuous}, AbstractVector{Multiclass{3}}, AbstractVector{Multiclass{2}}, AbstractVector{OrderedFactor{460}}, AbstractVector{OrderedFactor{70}}, AbstractVector{OrderedFactor{11}}, AbstractVector{OrderedFactor{4}}}}
    2:	Source @049 ⏎ AbstractVector{Multiclass{2}}</code></pre><h3 id="After-Oversampling"><a class="docs-heading-anchor" href="#After-Oversampling">After Oversampling</a><a id="After-Oversampling-1"></a><a class="docs-heading-anchor-permalink" href="#After-Oversampling" title="Permalink"></a></h3><pre><code class="language-julia hljs"># 3. Wrap it with the data in a machine
mach_over = machine(model, Xover, yover)

# 4. fit the machine learning model
fit!(mach_over)</code></pre><pre><code class="nohighlight hljs">┌ Info: Training machine(DecisionTreeClassifier(max_depth = 4, …), …).
└ @ MLJBase /Users/essam/.julia/packages/MLJBase/ByFwA/src/machines.jl:492



trained Machine; caches model-specific representations of data
  model: DecisionTreeClassifier(max_depth = 4, …)
  args: 
    1:	Source @033 ⏎ Table{Union{AbstractVector{Continuous}, AbstractVector{Multiclass{3}}, AbstractVector{Multiclass{2}}, AbstractVector{OrderedFactor{460}}, AbstractVector{OrderedFactor{70}}, AbstractVector{OrderedFactor{11}}, AbstractVector{OrderedFactor{4}}}}
    2:	Source @939 ⏎ AbstractVector{Multiclass{2}}</code></pre><h2 id="Evaluating-the-Model"><a class="docs-heading-anchor" href="#Evaluating-the-Model">Evaluating the Model</a><a id="Evaluating-the-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluating-the-Model" title="Permalink"></a></h2><p>To evaluate the model, we will use the balanced accuracy metric which equally accounts for all classes. </p><h3 id="Before-Oversampling-2"><a class="docs-heading-anchor" href="#Before-Oversampling-2">Before Oversampling</a><a class="docs-heading-anchor-permalink" href="#Before-Oversampling-2" title="Permalink"></a></h3><pre><code class="language-julia hljs">y_pred = predict_mode(mach, X_test)                         

score = round(balanced_accuracy(y_pred, y_test), digits=2)</code></pre><pre><code class="nohighlight hljs">0.57</code></pre><h3 id="After-Oversampling-2"><a class="docs-heading-anchor" href="#After-Oversampling-2">After Oversampling</a><a class="docs-heading-anchor-permalink" href="#After-Oversampling-2" title="Permalink"></a></h3><pre><code class="language-julia hljs">y_pred_over = predict_mode(mach_over, X_test)

score = round(balanced_accuracy(y_pred_over, y_test), digits=2)</code></pre><pre><code class="nohighlight hljs">0.7</code></pre><p>Although the results do get better compared to when we just used SMOTE, it may hold in this case that the extra categorical features we took into account are not be that important. The difference may be attributed to the decision tree.</p><h2 id="Evaluating-the-Model-Revisited"><a class="docs-heading-anchor" href="#Evaluating-the-Model-Revisited">Evaluating the Model - Revisited</a><a id="Evaluating-the-Model-Revisited-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluating-the-Model-Revisited" title="Permalink"></a></h2><p>We have previously evaluated the model using a single point estimate of the balanced accuracy resulting in a <code>13%</code> improvement. A more precise evaluation would use cross validation to combine many different point estimates into a more precise one (their average). The standard deviation among such point estimates also allows us to quantify the uncertainty of the estimate; a smaller standard deviation would imply a smaller confidence interval at the same probability.</p><h3 id="Before-Oversampling-3"><a class="docs-heading-anchor" href="#Before-Oversampling-3">Before Oversampling</a><a class="docs-heading-anchor-permalink" href="#Before-Oversampling-3" title="Permalink"></a></h3><pre><code class="language-julia hljs">cv=CV(nfolds=10)
evaluate!(mach, resampling=cv, measure=balanced_accuracy) </code></pre><pre><code class="nohighlight hljs">Evaluating over 10 folds: 100%[=========================] Time: 0:02:54[K



PerformanceEvaluation object with these fields:
  model, measure, operation, measurement, per_fold,
  per_observation, fitted_params_per_fold,
  report_per_fold, train_test_rows, resampling, repeats
Extract:
┌─────────────────────┬──────────────┬─────────────┬─────────┬──────────────────
│ measure             │ operation    │ measurement │ 1.96*SE │ per_fold        ⋯
├─────────────────────┼──────────────┼─────────────┼─────────┼──────────────────
│ BalancedAccuracy(   │ predict_mode │ 0.565       │ 0.00623 │ [0.568, 0.554,  ⋯
│   adjusted = false) │              │             │         │                 ⋯
└─────────────────────┴──────────────┴─────────────┴─────────┴──────────────────
                                                                1 column omitted</code></pre><p>Before oversampling, and assuming that the balanced accuracy score is normally distribued we can be <code>95%</code> confident that the balanced accuracy on new data is <code>56.5±0.62</code>. Indeed, this agrees a lot with the original point estimate.</p><h3 id="After-Oversampling-3"><a class="docs-heading-anchor" href="#After-Oversampling-3">After Oversampling</a><a class="docs-heading-anchor-permalink" href="#After-Oversampling-3" title="Permalink"></a></h3><p>At first glance, this seems really nontrivial since resampling will have to be performed before training the model on each fold during cross-validation. Thankfully, the <code>MLJBalancing</code> helps us avoid doing this manually by offering <code>BalancedModel</code> where we can wrap any <code>MLJ</code> classification model with an aribtrary number of <code>Imbalance.jl</code> resamplers in a pipeline that behaves like a single <code>MLJ</code> model.</p><p>In this, we must construct the resampling model via it&#39;s <code>MLJ</code> interface then pass it along with the classification model to <code>BalancedModel</code>.</p><pre><code class="language-julia hljs"># 2. Instantiate the models
oversampler = Imbalance.MLJ.SMOTENC(k=3, ratios=Dict(1=&gt;0.9), rng=42)

# 2.1 Wrap them in one model
balanced_model = BalancedModel(model=model, balancer1=oversampler)

# 3. Wrap it with the data in a machine
mach_over = machine(balanced_model, X_train, y_train, scitype_check_level=0)

# 4. fit the machine learning model
fit!(mach_over, verbosity=0)</code></pre><pre><code class="nohighlight hljs">trained Machine; does not cache data
  model: BalancedModelProbabilistic(model = DecisionTreeClassifier(max_depth = 4, …), …)
  args: 
    1:	Source @967 ⏎ Table{Union{AbstractVector{Continuous}, AbstractVector{Multiclass{3}}, AbstractVector{Multiclass{2}}, AbstractVector{OrderedFactor{460}}, AbstractVector{OrderedFactor{70}}, AbstractVector{OrderedFactor{11}}, AbstractVector{OrderedFactor{4}}}}
    2:	Source @394 ⏎ AbstractVector{Multiclass{2}}</code></pre><p>We can easily confirm that this is equivalent to what we had earlier</p><pre><code class="language-julia hljs">predict_mode(mach_over, X_test) == y_pred_over</code></pre><pre><code class="nohighlight hljs">true</code></pre><p>Now let&#39;s cross-validate</p><pre><code class="language-julia hljs">cv=CV(nfolds=10)
evaluate!(mach_over, resampling=cv, measure=balanced_accuracy) </code></pre><pre><code class="nohighlight hljs">Evaluating over 10 folds: 100%[=========================] Time: 0:07:24[K



PerformanceEvaluation object with these fields:
  model, measure, operation, measurement, per_fold,
  per_observation, fitted_params_per_fold,
  report_per_fold, train_test_rows, resampling, repeats
Extract:
┌─────────────────────┬──────────────┬─────────────┬─────────┬──────────────────
│ measure             │ operation    │ measurement │ 1.96*SE │ per_fold        ⋯
├─────────────────────┼──────────────┼─────────────┼─────────┼──────────────────
│ BalancedAccuracy(   │ predict_mode │ 0.677       │ 0.0124  │ [0.678, 0.688,  ⋯
│   adjusted = false) │              │             │         │                 ⋯
└─────────────────────┴──────────────┴─────────────┴─────────┴──────────────────
                                                                1 column omitted</code></pre><p>Fair enough. After oversampling the interval under the same assumptions is <code>67.7±1.2%</code> which is still a meaningful improvement over <code>56.5±0.62</code> that we had prior to oversampling ot the <code>55.2±1.5%</code> that we had with logistic regression and SMOTE in an earlier example.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.0 on <span class="colophon-date" title="Thursday 5 October 2023 14:39">Thursday 5 October 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
